<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Support</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="../static/main.css">
    </head>
    <body>
        <div style="margin: 20px; height: 90%; width: 100% position: absolute;">
        <h3>Support bot</h3>
        <hr>
        <p id="session_id" hidden>{{ session_id }}</p>
        <form action="/get_user" method="post" name="form">
            <div style="position: absolute; bottom: 0; right: 0; margin: 20px"><p>Введите сообщение: <textarea id="user_msg" rows="4" cols="20" name="user_msg_text"></textarea></p><a href="/quit"><button style="float:right;" type="button" name="button" onclick=add_user_msg()>Завершить сессию</button></a><button style="float:right;" type="button" name="button" onclick=add_user_msg()>Отправить</button></div>
        </form>
        <div style="width: 50%;" id="chat">
        </div>
        </div>
    </body>
    <script type="text/javascript">
        var userTemplateStart = '<div class="user"><p class="user">'
        var session_id = document.getElementById('session_id').innerHTML
        var userTemplateFinish = '</p></div>'
        var botTemplateStart = '<div class="bot"><p class="bot">'
        var botTemplateFinish = '</p></div>'
        var chat = document.getElementById('chat')
        function add_user_msg() {
            var text = document.getElementById('user_msg').value
            document.getElementById('user_msg').value = ""
            $.ajax({
                type: "POST",
                url: "/get_user?text=" + text + "&id=" + String(session_id),
                success: function(responses) {
                    console.log("OK");
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        function add_bot_msg() {
            $.ajax({
                type: "GET",
                url: "/get",
                success: function(responses) {
                    chat.innerHTML = ""
                    for(var i = 0; i < responses.length; i++) {
                        if(Number(session_id) == Number(responses[i].id)) {
                            if(String(responses[i].type) == "bot")
                                 chat.innerHTML += botTemplateStart + responses[i].text + botTemplateFinish
                            else
                                chat.innerHTML += userTemplateStart + responses[i].text + userTemplateFinish
                        }
                    }
                    // console.log(response, Number(session_id) == Number(response.id), Number(session_id), Number(response.id))
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        setInterval("add_bot_msg()", 1000);
    </script>
</html>
